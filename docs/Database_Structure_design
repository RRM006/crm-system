Perfect ğŸ‘ â€” letâ€™s build your **complete multitenant CRM database architecture** â€” fully expanded with all previously discussed and implied features (customers, vendors, communications, orders, pipeline, notes, etc.), now **tenant-aware** and **user-role flexible**.

Below is the **comprehensive conceptual schema** â€” table names, all key attributes, relationships, and keys â€” formatted for easy implementation in PostgreSQL or ORM tools later.

---

## ğŸ¢ **1. Multitenancy & User Management**

### **Table: `tenants`**

**Purpose:** Represents an organization or company that uses your CRM.

**Columns:**

- `tenant_id` (PK, UUID)
- `name`
- `domain`
- `plan` (e.g., Free, Pro, Enterprise)
- `created_at`
- `updated_at`

**Relationships:**

- One `tenant` â†’ Many users via `user_memberships`
- One `tenant` â†’ Owns data across all CRM entities

---

### **Table: `users`**

**Purpose:** Global user accounts shared across tenants.

**Columns:**

- `user_id` (PK, UUID)
- `email` (unique)
- `password_hash`
- `full_name`
- `phone`
- `profile_picture`
- `language`
- `timezone`
- `is_superadmin` (system-wide)
- `created_at`
- `last_login`

**Relationships:**

- One `user` â†’ Many `user_memberships`
- Can own or modify CRM data (via memberships)

---

### **Table: `roles`**

**Purpose:** Defines roles for users per tenant.

**Columns:**

- `role_id` (PK)
- `name` (Admin, Manager, SalesRep, Support, Vendor, Customer)
- `description`

---

### **Table: `user_memberships`**

**Purpose:** Links users to tenants with specific roles and attributes.

**Columns:**

- `membership_id` (PK, UUID)
- `tenant_id` (FK â†’ tenants)
- `user_id` (FK â†’ users)
- `role_id` (FK â†’ roles)
- `is_vendor` (boolean)
- `is_customer` (boolean)
- `status` (active, pending, suspended)
- `metadata` (JSON)
- `created_at`

**Relationships:**

- Many-to-one â†’ `tenants`
- Many-to-one â†’ `users`
- One-to-one â†’ `roles`

---

## ğŸ§â€â™‚ï¸ **2. Parties & Contacts**

### **Table: `parties`**

**Purpose:** Abstract entity for both customers and vendors.

**Columns:**

- `party_id` (PK, UUID)
- `tenant_id` (FK â†’ tenants)
- `type` (Organization, Individual)
- `name`
- `industry`
- `is_vendor` (boolean)
- `is_customer` (boolean)
- `website`
- `tax_number`
- `rating` (Aâ€“F or 1â€“5 scale)
- `source` (referral, web form, import, etc.)
- `created_at`
- `updated_at`
- `meta` (JSON)

**Relationships:**

- One-to-many â†’ `contacts`, `opportunities`, `orders`, `communications`

---

### **Table: `addresses`**

**Purpose:** Standardized address storage for parties or contacts.

**Columns:**

- `address_id` (PK, UUID)
- `tenant_id` (FK â†’ tenants)
- `party_id` (FK â†’ parties, nullable)
- `contact_id` (FK â†’ contacts, nullable)
- `address_type` (billing, shipping, office, home)
- `street`
- `city`
- `state`
- `postal_code`
- `country`
- `is_primary`
- `created_at`

---

### **Table: `contacts`**

**Purpose:** Individual people within a party (customers, vendors, leads).

**Columns:**

- `contact_id` (PK, UUID)
- `tenant_id` (FK â†’ tenants)
- `party_id` (FK â†’ parties)
- `first_name`
- `last_name`
- `email`
- `phone`
- `job_title`
- `department`
- `linkedin_url`
- `is_primary`
- `created_at`

---

## ğŸ’¼ **3. Products & Orders**

### **Table: `products`**

**Purpose:** Product or service catalog per tenant.

**Columns:**

- `product_id` (PK, UUID)
- `tenant_id` (FK â†’ tenants)
- `name`
- `sku`
- `description`
- `category`
- `price`
- `currency`
- `tax_rate`
- `stock_quantity`
- `unit_of_measure`
- `is_active`
- `created_at`
- `updated_at`

---

### **Table: `orders`**

**Purpose:** Tracks sales/purchase orders.

**Columns:**

- `order_id` (PK, UUID)
- `tenant_id` (FK â†’ tenants)
- `party_id` (FK â†’ parties)
- `contact_id` (FK â†’ contacts)
- `order_number`
- `order_date`
- `due_date`
- `status` (Draft, Confirmed, Shipped, Completed, Cancelled)
- `payment_status` (Pending, Paid, Partial)
- `shipping_address_id` (FK â†’ addresses)
- `billing_address_id` (FK â†’ addresses)
- `total_amount`
- `currency`
- `notes`
- `created_by` (FK â†’ users)
- `created_at`

---

### **Table: `order_items`**

**Purpose:** Line items within an order.

**Columns:**

- `order_item_id` (PK, UUID)
- `order_id` (FK â†’ orders)
- `product_id` (FK â†’ products)
- `quantity`
- `unit_price`
- `discount`
- `subtotal`
- `tax_amount`
- `total_price`

---

## ğŸ’¬ **4. Communications**

### **Table: `communication_channels`**

**Purpose:** Lookup table for different channel types.

**Columns:**

- `channel_id` (PK)
- `name` (Phone, Email, Telegram, SMS, WhatsApp)
- `is_active`

---

### **Table: `phone_calls`**

**Purpose:** Logs all customer/vendor phone calls.

**Columns:**

- `call_id` (PK, UUID)
- `tenant_id` (FK â†’ tenants)
- `party_id` (FK â†’ parties)
- `contact_id` (FK â†’ contacts)
- `user_id` (FK â†’ users)
- `direction` (Inbound/Outbound)
- `start_time`
- `end_time`
- `duration_seconds`
- `recording_url`
- `transcription_status`
- `created_at`

---

### **Table: `call_transcripts`**

**Purpose:** Stores transcribed text from phone calls.

**Columns:**

- `transcript_id` (PK, UUID)
- `call_id` (FK â†’ phone_calls)
- `tenant_id` (FK â†’ tenants)
- `transcript_text`
- `language`
- `confidence`
- `summary`
- `keywords`
- `sentiment_score`
- `created_at`

---

### **Table: `emails`**

**Purpose:** Email logging and message tracking.

**Columns:**

- `email_id` (PK, UUID)
- `tenant_id` (FK â†’ tenants)
- `party_id` (FK â†’ parties)
- `contact_id` (FK â†’ contacts)
- `user_id` (FK â†’ users)
- `direction` (Inbound/Outbound)
- `subject`
- `body`
- `message_id`
- `status` (Sent, Received, Failed, Draft)
- `attachments` (JSON)
- `sent_at`
- `created_at`

---

### **Table: `telegram_messages`**

**Purpose:** Stores Telegram messages linked to customers/vendors.

**Columns:**

- `message_id` (PK, BIGINT)
- `tenant_id` (FK â†’ tenants)
- `party_id` (FK â†’ parties)
- `contact_id` (FK â†’ contacts)
- `user_id` (FK â†’ users)
- `direction` (Inbound/Outbound)
- `chat_id`
- `message_text`
- `message_type` (Text, File, Voice, Image)
- `attachment_url`
- `sent_at`
- `created_at`

---

## ğŸ“Š **5. Sales Pipeline & Opportunities**

### **Table: `pipelines`**

**Purpose:** Defines sales pipelines per tenant.

**Columns:**

- `pipeline_id` (PK, UUID)
- `tenant_id` (FK â†’ tenants)
- `name`
- `description`
- `is_default`
- `created_at`

---

### **Table: `pipeline_stages`**

**Purpose:** Defines ordered stages in a pipeline.

**Columns:**

- `stage_id` (PK, UUID)
- `pipeline_id` (FK â†’ pipelines)
- `name`
- `position`
- `probability`
- `is_final`
- `created_at`

---

### **Table: `opportunities`**

**Purpose:** Tracks deals or potential sales.

**Columns:**

- `opportunity_id` (PK, UUID)
- `tenant_id` (FK â†’ tenants)
- `pipeline_id` (FK â†’ pipelines)
- `stage_id` (FK â†’ pipeline_stages)
- `party_id` (FK â†’ parties)
- `contact_id` (FK â†’ contacts)
- `title`
- `value`
- `currency`
- `expected_close_date`
- `stage_entered_at`
- `source` (web, referral, import)
- `priority` (Low, Medium, High)
- `probability` (auto from stage or manual)
- `assigned_to` (FK â†’ users)
- `created_by` (FK â†’ users)
- `created_at`
- `updated_at`

---

### **Table: `opportunity_stage_history`**

**Purpose:** Logs all stage transitions automatically.

**Columns:**

- `history_id` (PK, UUID)
- `tenant_id` (FK â†’ tenants)
- `opportunity_id` (FK â†’ opportunities)
- `old_stage_id` (FK â†’ pipeline_stages)
- `new_stage_id` (FK â†’ pipeline_stages)
- `changed_by` (FK â†’ users)
- `change_reason`
- `changed_at`
- `duration_in_stage`

---

## ğŸ§¾ **6. Collaboration & Internal Tools**

### **Table: `notes`**

**Purpose:** Internal notes related to entities.

**Columns:**

- `note_id` (PK, UUID)
- `tenant_id` (FK â†’ tenants)
- `related_type` (Opportunity, Order, Party, Product)
- `related_id` (UUID)
- `content`
- `created_by` (FK â†’ users)
- `created_at`

---

### **Table: `attachments`**

**Purpose:** Files uploaded and linked to entities.

**Columns:**

- `attachment_id` (PK, UUID)
- `tenant_id` (FK â†’ tenants)
- `related_type`
- `related_id`
- `filename`
- `url`
- `mime_type`
- `uploaded_by` (FK â†’ users)
- `uploaded_at`

---

### **Table: `activity_logs`**

**Purpose:** System log for auditing user actions.

**Columns:**

- `activity_id` (PK, UUID)
- `tenant_id` (FK â†’ tenants)
- `user_id` (FK â†’ users)
- `action` (Created Opportunity, Sent Email, Logged Call, etc.)
- `related_type`
- `related_id`
- `meta` (JSON)
- `created_at`

---

## ğŸ” **7. Keys & Relationships Summary**

### **Primary Keys:**

All tables have primary keys:

- UUID-based except Telegram (BIGINT).

### **Foreign Key Relationships Overview:**

- `user_memberships.tenant_id` â†’ `tenants.tenant_id`
- `user_memberships.user_id` â†’ `users.user_id`
- `user_memberships.role_id` â†’ `roles.role_id`
- `contacts.party_id` â†’ `parties.party_id`
- `parties.tenant_id` â†’ `tenants.tenant_id`
- `addresses.party_id/contact_id` â†’ optional
- `orders.party_id` â†’ `parties.party_id`
- `orders.created_by` â†’ `users.user_id`
- `order_items.order_id` â†’ `orders.order_id`
- `products.tenant_id` â†’ `tenants.tenant_id`
- `opportunities.pipeline_id` â†’ `pipelines.pipeline_id`
- `opportunities.stage_id` â†’ `pipeline_stages.stage_id`
- `opportunities.party_id` â†’ `parties.party_id`
- `opportunity_stage_history.opportunity_id` â†’ `opportunities.opportunity_id`
- `phone_calls.party_id` â†’ `parties.party_id`
- `call_transcripts.call_id` â†’ `phone_calls.call_id`
- `emails.party_id` â†’ `parties.party_id`
- `telegram_messages.party_id` â†’ `parties.party_id`
- `attachments.related_id` â†’ polymorphic references (UUIDs)
- `activity_logs.user_id` â†’ `users.user_id`

### **Tenant Isolation:**

All entity tables contain `tenant_id` and are protected with RLS.

Excellent â€” youâ€™re now moving into **issue tracking / ticketing** functionality, which integrates with your CRMâ€™s customer data.
Weâ€™ll design this feature so that:

1. It fits **cleanly into your multitenant architecture**,
2. Can **integrate external issue APIs** (like Jira, GitHub Issues, or Freshdesk), and
3. Allows **internal issue management** if API integration isnâ€™t available.

Letâ€™s expand your database design accordingly.

---

## ğŸ§¾ **New Tables for Issue Tracking**

### **Table: `issue_integrations`**

**Purpose:** Stores API connection details for each tenantâ€™s issue tracking system.

**Columns:**

- `integration_id` (PK, UUID)
- `tenant_id` (FK â†’ tenants)
- `service_name` (e.g., Jira, GitHub, Zendesk, Custom)
- `api_base_url`
- `api_key` (encrypted or stored in vault)
- `auth_type` (API_KEY, OAuth2, BasicAuth)
- `is_active`
- `last_sync_at`
- `created_at`

**Relationships:**

- One tenant â†’ One or many issue integrations.

---

### **Table: `issues`**

**Purpose:** Main issue or ticket record, synced with or created from API.

**Columns:**

- `issue_id` (PK, UUID)
- `tenant_id` (FK â†’ tenants)
- `integration_id` (FK â†’ issue_integrations, nullable)
- `external_issue_id` (ID from Jira/GitHub/etc.)
- `party_id` (FK â†’ parties, for customer/vendor link)
- `contact_id` (FK â†’ contacts, nullable)
- `title`
- `description`
- `priority` (Low, Medium, High, Critical)
- `status` (Open, In Progress, Resolved, Closed, Reopened)
- `category` (Bug, Request, Inquiry, etc.)
- `assigned_to` (FK â†’ users)
- `reported_by` (FK â†’ users or contacts)
- `source` (Web, API, Email, Telegram, etc.)
- `created_at`
- `updated_at`
- `closed_at`
- `synced_at` (for API sync timestamp)

**Relationships:**

- Linked to both internal CRM users and external integrations.
- One issue â†’ Many comments, attachments, activities.

---

### **Table: `issue_comments`**

**Purpose:** Tracks discussion or updates on an issue.

**Columns:**

- `comment_id` (PK, UUID)
- `issue_id` (FK â†’ issues)
- `tenant_id` (FK â†’ tenants)
- `author_id` (FK â†’ users, nullable)
- `external_comment_id` (from API, nullable)
- `content`
- `visibility` (Public, Internal)
- `created_at`

**Relationships:**

- Many comments â†’ One issue.

---

### **Table: `issue_attachments`**

**Purpose:** Attach files or screenshots to issues.

**Columns:**

- `attachment_id` (PK, UUID)
- `issue_id` (FK â†’ issues)
- `tenant_id` (FK â†’ tenants)
- `filename`
- `url`
- `mime_type`
- `uploaded_by` (FK â†’ users)
- `uploaded_at`

---

### **Table: `issue_activity_logs`**

**Purpose:** Auditing â€” logs state changes or API sync events.

**Columns:**

- `activity_id` (PK, UUID)
- `tenant_id` (FK â†’ tenants)
- `issue_id` (FK â†’ issues)
- `user_id` (FK â†’ users, nullable)
- `action` (Created, Assigned, Status Changed, Synced, Comment Added)
- `old_value`
- `new_value`
- `timestamp`

---

## ğŸ”— **Relationships Overview**

| Relationship                     | Type | Description                                      |
| -------------------------------- | ---- | ------------------------------------------------ |
| `issue_integrations` â†’ `tenants` | 1:N  | Each tenant can integrate multiple issue systems |
| `issues` â†’ `issue_integrations`  | N:1  | Optional link to an external API                 |
| `issues` â†’ `parties`             | N:1  | Issue belongs to a customer/vendor               |
| `issues` â†’ `contacts`            | N:1  | Optional direct reporter contact                 |
| `issues` â†’ `users (assigned_to)` | N:1  | Assigned CRM user                                |
| `issue_comments` â†’ `issues`      | N:1  | Comments linked to issue                         |
| `issue_attachments` â†’ `issues`   | N:1  | Attachments linked to issue                      |
| `issue_activity_logs` â†’ `issues` | N:1  | Audit trail for changes                          |

---

## ğŸŒ **API Integration Flow**

1. **Tenant Setup** â€” Admin configures API key or OAuth for Jira/GitHub/etc. in `issue_integrations`.
2. **Pull Sync** â€” Cron job or webhook fetches issues, maps them to internal `issues` table (using `external_issue_id`).
3. **Push Sync** â€” When a CRM user creates or updates an issue, it pushes changes to the connected service.
4. **Two-way Sync** â€” Comments, attachments, and status updates stay in sync between the CRM and the external system.

---

Would you like me to **extend the ERD** to include this issue-tracking subsystem (linked to `parties`, `users`, and `tenants`)?
Itâ€™ll show how the new tables connect visually with the rest of your CRM model.

---

âœ… **Result:**
You now have a **fully multitenant CRM database design** that:

- Allows a single `user` to act as both **vendor and customer** in different contexts
- Tracks **calls, emails, Telegram chats, and orders**
- Maintains **pipeline and stage analytics**
- Supports **shared tenants with per-user roles**
- Includes **addresses, products, notes, attachments, and audit logs**
